parameters:
  # Provde a list of repos
  # Example:
  #   Azure/azure-rest-api-specs:
  #     Branch: main
  #     TargetRepos:
  #       Azure/azure-rest-api-specs-pr:
  #         Branch: RPSaaSDev
  #         Theirs: "**"
  #         Ours: "specification"
  #         Merge: "specification/common-types"

  - name: Repos
    type: object
  - name: GH_TOKEN
    type: string
  - name: ScriptDirectory
    type: string
    default: eng/scripts
  - name: WorkingDirectory
    type: string
    default: $(System.DefaultWorkingDirectory)

steps:

- ${{ each repo in parameters.Repos }}:

  - ${{ each target in repo.value.TargetRepos }}:

    - pwsh: |
      #git clone target



    - task: PowerShell@2
      displayName: Sync Repo Branch from ${{ repo.key }} to ${{ target.key }}
      inputs:
        pwsh: true
        workingDirectory: ${{ parameters.WorkingDirectory }}
        filePath: ${{ parameters.ScriptDirectory }}/Merge-Branch.ps1
        arguments: >
          -SourceRepo '${{ repo.key }}'
          -SourceBranch '${{ repo.value.Branch }}'
          -TargetRepo '${{ target.key }}'
          -TargetBranch '${{ coalesce(target.value.Branch, repo.value.Branch) }}'
          -Rebase '${{ target.value.Rebase }}'
          -AuthToken '${{ parameters.GH_TOKEN }}'
